# Intelligent Placer
## Постановка задачи
Требуется по поданной на вход фотографии нескольких предметов на светлой горизонтальной поверхности и многоугольнику определить, какие предметы можно вписать в многоугольник до его наибольшего заполнения. Предметы и горизонтальная поверхность, которые могут оказаться на фотографии, заранее известны. Также заранее известно направление вертикальной оси Z у этих предметов. Многоугольник задаётся фигурой, нарисованной темным маркером на белом листе бумаги, сфотографированной вместе с предметами. “Intelligent Placer” должен быть оформлен в виде python-библиотеки intelligent_placer_lib, которая поставляется каталогом intelligent_placer_lib с файлом intelligent_placer.py, содержащим функцию - точку входа:

```python
def check_image(<path_to_png_jpg_image_on_local_computer>[, <poligon_coordinates>])
```
которая возвращает бинарное изображение с таким расположением предметов, которое обеспечивает наибольшее покрытие многоугольника.

```python
from intelligent_placer_lib import intelligent_placer
def test_intelligent_placer():
	assert intelligent_placer.check_image(“/path/to/my/image.png”)
```
Также требуется воспроизводимый intelligent_placer.ipynb, содержащий репрезентативные примеры работы алгоритма с оценками качества его работы и их визуализацией.

### Описание входных данных
- Допустимое разрешение входных фотографий: не менее 1280х1280;
- Высота съемки: не менее 40 см (в общем случае - достаточная для размещения листа А4 и некоторого количества предметов);
- Угол наклона камеры: не более 5 градусов (в идеале 0 дабы избежать нежелательных теней);
- Степень размытости фотографии: фотография должна быть максимально чёткой для беззатруднительного зрительного определения границ предметов, толщина линии границы не более 10 px;
- Допустимые форматы фотографий: png, jpg;
- Размещение предметов: вне листа с многоугольником, вертикально, по одну сторону, без перекрытия, с интервалом ~ 2см между предметами;
- Размещение листа с многоугольником: приблизительно в центре фотографии, ориентация - документ (самая длинная сторона - приблизительно вертикально относительно фотографии);
- Параметры многоугольника: нарисован тёмным маркером (ручкой) на белом листе формата А4, количество вершин - не более 15;
- Параметры фона: предмет (покрытие) сплошного светлого (близкого к белому) цвета;
- Дополнительно: 
  - Несколько экземпляров одного предмета будут расениваться как один предмет;
  - Во избежание возникновения теней рекомендуется воспользоваться несколькими источниками света;

### Описание выходных данных
Список, составленный из индексов вмещаемых предметов. Индексация самих предметов производится сверху вниз относительно фотографии.

### Решаемые задачи
1. Задача определения многоугольника
2. Задача определения предмета
3. Задача укладки (иными словами, наиболее эффективное с точки зрения постановки задачи расположение предметов в многоугольнике)

В первую задачу входит определение многоугольника на заданной фотографии и создание его программной модели по найденным параметрам.
Вторая задача включает в себя обнаружение предметов, определение их параметров с последующим созданием модели.
Отдельно в мини-задачу можно отнести различие многоугольника и предмета. В процессе разработки алгоритма данный момент будет рассмотрен более детально, в последствии этот пункт будет дополнен непосредственно в плане.
Третья задача по сути основная - разработка алгоритма, позволяющего при произвольном входе, удовлетворяющем требованиям, выдать список помещающихся предметов наибольшей суммарной площади.

### Метрика качества
Метрикой качества работы алгоритма служит доля покрытия R - отношение площади покрытия прямоугольника к суммарной площади всех предметов:

![alt text](Data/Formulas/Ratio.png)

## Сбор данных
### Рассматриваемые объекты
#### Значок
![alt text](Data/Objects/Badge.jpg)
#### Брелок
![alt text](Data/Objects/Charm.jpg)
#### Деталь кубика рубика
![alt text](Data/Objects/Detail.jpg)
#### Беспроводной наушник
![alt text](Data/Objects/Headphone.jpg)
#### Текстовыделитель
![alt text](Data/Objects/Highlighter.jpg)
#### Медиатор
![alt text](Data/Objects/Mediator.jpg)
#### Карандаш
![alt text](Data/Objects/Pencil.jpg)
#### Отвертка
![alt text](Data/Objects/Screwdriver.jpg)
#### Игрушечная пуля
![alt text](Data/Objects/SoftBullet.jpg)
#### Жетон
![alt text](Data/Objects/Token.jpg)
#### Поверхность съемки
![alt text](Data/Objects/Surface.jpg)

### Примеры
#### Пример 1
##### Вход: 
![alt text](Data/Examples/Example_1.jpg)
##### Получившийся результат:
![alt text](Data/Results/result_1.jpg)
##### Комментарий:
Тривиальный пример, 1 предмет, помещающийся в заданный многоугольник. Рассматривается ситуация, когда укладывается 1 из 1 предметов.

#### Пример 2
##### Вход: 
![alt text](Data/Examples/Example_2.jpg)
##### Получившийся результат:
![alt text](Data/Results/result_2.jpg)
##### Комментарий:
Тривиальный пример, 1 предмет, непомещающийся в заданный многоугольник. Рассматривается ситуация, когда укладывается 0 из 1 предметов.

#### Пример 3
##### Вход: 
![alt text](Data/Examples/Example_3.jpg)
##### Получившийся результат:
![alt text](Data/Results/result_3.jpg)
##### Комментарий:
2 предмета, только 1 из которых укладывается в заданный многоугольник. Рассматривается ситуация, когда укладывается 1 из 2 предметов.

#### Пример 4
##### Вход: 
![alt text](Data/Examples/Example_4.jpg)
##### Получившийся результат:
![alt text](Data/Results/result_4.jpg)
##### Комментарий:
2 предмета, оба по отдельности укладываются в заданный многоугольник. Рассматривается ситуация, когда укладывается 2 из 2 предметов, однако выбор падает на объект с наибольшей площадью.

#### Пример 5
##### Вход: 
![alt text](Data/Examples/Example_5.jpg)
##### Получившийся результат:
![alt text](Data/Results/result_5.jpg)
##### Комментарий:
0 предметов, краевой случай с пустым (в смысле наличия предметов) входом.

#### Пример 6
##### Вход: 
![alt text](Data/Examples/Example_6.jpg)
##### Получившийся результат:
![alt text](Data/Results/result_6.jpg)
##### Комментарий:
3 предмета, все отдельности укладываются в заданный многоугольник. Рассматривается ситуация, когда укладывается 3 из 3 предметов, однако выбор падает на объекты 0 и 1, так как они оба помещаются, и их суммарная площадь наибольшая.

#### Пример 7
##### Вход: 
![alt text](Data/Examples/Example_7.jpg)
##### Получившийся результат:
![alt text](Data/Results/result_7.jpg)
##### Комментарий:
2 предмета, оба отдельности укладываются в заданный многоугольник. Рассматривается ситуация, когда укладывается 2 из 2 предметов, причем одновременно.

#### Пример 8
##### Вход: 
![alt text](Data/Examples/Example_8.jpg)
##### Получившийся результат:
![alt text](Data/Results/result_8.jpg)
##### Комментарий:
3 одинаковых предмета, все отдельности укладываются в заданный многоугольник. Рассматривается ситуация, когда укладывается 3 из 3 одинаковых предметов, одновременно можно уложить 2 из них.

#### Пример 9
##### Вход: 
![alt text](Data/Examples/Example_9.jpg)
##### Получившийся результат:
![alt text](Data/Results/result_9.jpg)
##### Комментарий:
N предметов, никакой из них не укладывается в заданный многоугольник. Рассматривается ситуация, когда не укладывается произвольное количество предметов.

#### Пример 10
##### Вход: 
![alt text](Data/Examples/Example_10.jpg)
##### Получившийся результат:
![alt text](Data/Results/result_10.jpg)
##### Комментарий:
N предметов, все по отдельности и вместе укладывается в заданный многоугольник. Рассматривается ситуация, когда одновременно укладывается произвольное количество предметов.

#### Пример 11
##### Вход: 
![alt text](Data/Examples/Example_11.jpg)
##### Получившийся результат:
![alt text](Data/Results/result_11.jpg)
##### Комментарий:
Дополнительный пример работы, затрагивающий оставшиеся выбранные предметы.


## План работы
Работу над данным проектом разделена на следующие этапы:
- Определение рабочей области - фрагмента изображения, на котором расположены непосредственно многоугольник и объекты на светлом фоне, излишние детали фона обрезаны;
  - Определение рабочей области происходит с помощью выделения наибольшего замкнутого контура изображения, коим является поверхность для съемки предметов вместе с многоугольником.
  - Выделение контура происходит с помощью грубого алгоритма Кэни.
- Выделение структурных элементов - многоугольника и объектов, притом каждый элемент представлен на своём отдельном изображении
  - Выделение элементов происходит с помощью более точного алгоритма Кэни.
  - На этом этапе не ясно, какой из элементов является многоугольником, а какой - объектом.
- Разделение объектов и многоугольника в соответсвтующие контейнеры;
  - Разделение происходит по следующему принципу - черно-белый фрагмент фотографии, доминирующий цвет которого наиболее близок к белому, является многоугольником, остальные - объекты.
- Представление объектов и прямоугольника в виде бинарной маски;
- Размещение объектов внутри многоугольника:
  - На вход функции размещения поступают отсортированные по пллощади маски объектов и маска многоугольника;
  - Затем генерируются комбинации индексов предметов таким образом, чтобы сначала шли наибольшие по площади объекты;
  - Для непосредственно размещения производится перебор углов поворота и положений маски объекта на маске многоугольника:
    - Удачным пересечением считается совпадение результата операции "БИНАРНОЕ И" и маски объекта;
    - В случае удачного пересечения маска многоугольника представляется в виде результата операции "БИНАРНОЕ ИСКЛЮЧАЮЩЕЕ ИЛИ";
  - Далее проводится проверка: 
    - Если удалось разместить все предметы, то сохраняется и выводится соответсвтующее изображение;
    - Иначе - запоминается площадь покрытия, переход к следующей комбинации предметов;
    - В случае невозможности размещения никакого из объктов возвращается пустая маска многоугольника.
  - Для оптимизации перебора производится предварительное сжатие масок как объектов, так и многоугольника. Также рассматривается перебор углов с шагом 10 градусов.
- Вывод результатов;
  - Вывод производится в фигуру, поставляемую matplotlib, так как с ее помощью возможна удобная работа с получившимся изображением и последующее его сохранение.

## Пример работы
Чтобы ознакомиться с примерами работы, просмотрите intelligent_placer.ipynb

## Инструкция по запуску
- Перейдите в желаемую рабочую директорию и клонируйте репозиторий, выполнив команду:
```
git clone https://github.com/Drusiand/Intelligent_Placer.git
```
- Перейдите в папку репозитория
- Установите необхоимые зависимости, выполнив команду
```
pip install -r requirements.txt
```
- Запустите программу, выполнив команду
```
python main.py --path path/to/your/image
```
Путь к изображению указывается после ключевых слов -p или --path
## История изменений:
- 04.04.2022
  - Изменена формулировки задачи - теперь вместо списка индексов вмещаемых предметов возвращается бинарное изображение с вариантом укладки, дающим наибольшее покрытие многоугольника;
  - Добавлена метрика качества работы алгоритма в соответствие с поставленной задачей;
  - Добавлен пример 11, затрагивающий упущенные в прошлом предметы;
  - Исправлен предполагаемый выход для каждого из примеров;
  - Дополнен план работы;
  - Дополнен intelligent_placer.ipynb;
  - Добавлена инструкция по запуску;
